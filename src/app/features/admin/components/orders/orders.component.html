<div class="orders-page">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (toastMessage()) {
  <div class="toast-notification" [class.error]="toastIsError()">
    <span class="toast-icon">{{ toastIsError() ? 'ğŸ˜¿' : 'âœ¨' }}</span>
    <span>{{ toastMessage() }}</span>
  </div>
  }

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL: BORRAR PEDIDO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->


  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL: GESTIONAR PEDIDO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (orderToEdit()) {
  <div class="modal-overlay" (click)="orderToEdit.set(null)">
    <div class="modal-card edit-modal" (click)="$event.stopPropagation()">

      <div class="edit-modal-header">
        <div class="edit-modal-bg-blur"></div>
        <div class="sparkle-row">
          <span>âœ¨</span><span>ğŸ’–</span><span>âœ¨</span>
        </div>
        <h3>Gestionar Pedido</h3>
        <p class="client-title">{{ orderToEdit()!.clientName }}</p>
        <button class="btn-close-modal" (click)="orderToEdit.set(null)">âœ•</button>
      </div>

      <div class="edit-modal-body">
        <div class="edit-section">
          <label class="field-label">ğŸ‘¤ Cliente</label>
          <input type="text" [(ngModel)]="editData.clientName" placeholder="Nombre" class="fancy-input">
          <input type="text" appGoogleAutocomplete (onAddressChange)="handleAddressChange($event)"
            [(ngModel)]="editData.clientAddress" placeholder="DirecciÃ³n" class="fancy-input" style="margin-top: 5px">
          <input type="text" [(ngModel)]="editData.clientPhone" placeholder="TelÃ©fono" class="fancy-input"
            style="margin-top: 5px">
        </div>

        <div class="edit-section">
          <label class="field-label">ğŸ“¦ MÃ©todo de Entrega</label>
          <div class="type-switch">
            <button [class.active]="editData.orderType === 'Delivery'" (click)="editData.orderType = 'Delivery'">
              <span class="switch-icon">ğŸ›µ</span><span>EnvÃ­o</span>
            </button>
            <button [class.active]="editData.orderType === 'PickUp'" (click)="editData.orderType = 'PickUp'">
              <span class="switch-icon">ğŸ›ï¸</span><span>Local</span>
            </button>
          </div>

          @if (editData.orderType === 'Delivery') {
          <div class="field-row" style="margin-top: 10px;">
            <label class="mini-label">Hora estipulada</label>
            <input type="time" [(ngModel)]="editData.deliveryTime" class="fancy-input">
          </div>
          } @else {
          <div class="field-row" style="margin-top: 10px;">
            <label class="mini-label">Fecha de RecolecciÃ³n</label>
            <input type="date" [(ngModel)]="editData.pickupDate" class="fancy-input">
            <input type="time" [(ngModel)]="editData.deliveryTime" class="fancy-input" style="margin-top:5px">
          </div>
          }
        </div>

        <div class="edit-section">
          <label class="field-label">ğŸ€ Estatus del Pedido</label>
          <div class="status-pills-selector">
            <button class="status-pill-btn" [class.active]="editData.status === 'Pending'"
              (click)="editData.status = 'Pending'">â³ Pendiente</button>
            <button class="status-pill-btn" [class.active]="editData.status === 'Shipped'"
              (click)="editData.status = 'Shipped'">ğŸ“¦ Enviado</button>
            <button class="status-pill-btn" [class.active]="editData.status === 'Delivered'"
              (click)="editData.status = 'Delivered'">ğŸ’ Entregado</button>
            <button class="status-pill-btn" [class.active]="editData.status === 'Canceled'"
              (click)="editData.status = 'Canceled'">ğŸš« Cancelado</button>
            <button class="status-pill-btn" [class.active]="editData.status === 'Postponed'"
              (click)="editData.status = 'Postponed'">ğŸ“… Posponer</button>
          </div>
        </div>

        <div class="edit-section">
          <label class="field-label">ğŸ·ï¸ Etiquetas</label>
          <div class="tags-selector">
            @for (tag of availableTags; track tag) {
            <button class="tag-btn" [class.active]="editData.tags.includes(tag)" (click)="toggleTag(tag)">
              {{ tag }}
            </button>
            }
          </div>
        </div>

        @if (editData.status === 'Postponed') {
        <div class="postponed-box">
          <div class="field">
            <label class="field-label">ğŸ“… Â¿CuÃ¡ndo entregamos?</label>
            <input type="datetime-local" [(ngModel)]="editData.postponedAt" class="fancy-input">
          </div>
          <div class="field">
            <label class="field-label">ğŸ“ Nota rÃ¡pida</label>
            <input type="text" [(ngModel)]="editData.postponedNote" placeholder="Ej. Cambio de horario"
              class="fancy-input">
          </div>
        </div>
        }

        <div class="edit-section">
          <label class="field-label">ğŸ“± Notificaciones WhatsApp</label>
          <div class="whatsapp-actions">
            <button class="btn-wa" (click)="sendWaConfirmation()">âœ… ConfirmaciÃ³n</button>
            <button class="btn-wa" (click)="sendWaOnWay()">ğŸš— En Camino</button>
            <button class="btn-wa" (click)="sendWaPayment()">ğŸ’¸ Cobro</button>
          </div>
        </div>
      </div>

      <div class="edit-modal-footer">
        <button class="btn-modal-cancel" (click)="orderToEdit.set(null)">Cerrar</button>
        <button class="btn-modal-pink" (click)="saveEdit()">ğŸ’¾ Guardar cambios</button>
      </div>
    </div>
  </div>
  }

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL: CONFIRMAR COBRO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (selectedOrderForPayment()) {
  <div class="modal-overlay" (click)="selectedOrderForPayment.set(null)">
    <div class="modal-card" style="max-width: 400px;" (click)="$event.stopPropagation()">
      <div class="edit-modal-header">
        <h3>Confirmar Cobro ğŸ’¸</h3>
        <p class="client-title">{{ selectedOrderForPayment()!.clientName }}</p>
        <button class="btn-close-modal" (click)="selectedOrderForPayment.set(null)">âœ•</button>
      </div>
      <div class="edit-modal-body" style="display: block;">
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <p style="font-size: 1.5rem; font-weight: 800; color: var(--pink-600); margin: 0;">
            $ {{ selectedOrderForPayment()!.total | number:'1.2-2' }}
          </p>
          <p style="color: #888; margin: 5px 0 0;">Total a cobrar</p>
        </div>

        <div class="edit-section">
          <label class="field-label">MÃ©todo de Pago</label>
          <div class="type-switch">
            <button [class.active]="paymentMethod() === 'Efectivo'" (click)="paymentMethod.set('Efectivo')">ğŸ’µ
              Efectivo</button>
            <button [class.active]="paymentMethod() === 'Transferencia'" (click)="paymentMethod.set('Transferencia')">ğŸ¦
              Transferencia</button>
            <button [class.active]="paymentMethod() === 'Tarjeta'" (click)="paymentMethod.set('Tarjeta')">ğŸ’³
              Tarjeta</button>
          </div>
        </div>

        <div class="edit-modal-footer" style="margin-top: 2rem; justify-content: center;">
          <button class="btn-modal-cancel" (click)="selectedOrderForPayment.set(null)">Cancelar</button>
          <button class="btn-modal-pink" [disabled]="confirmingPayment()" (click)="confirmPayment()">
            {{ confirmingPayment() ? 'Procesando...' : 'âœ… Confirmar Cobro' }}
          </button>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DRAWER: AGREGAR ARTÃCULO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (drawerOrder()) {
  <div class="drawer-overlay" (click)="closeDrawer()">
    <div class="drawer-panel" [class.open]="drawerOpen()" (click)="$event.stopPropagation()">

      <div class="drawer-header">
        <div class="drawer-grab"></div>
        <h3>Agregar artÃ­culo</h3>
        <p class="drawer-subtitle">{{ drawerOrder()?.clientName }} ğŸ›ï¸</p>
        <button class="btn-close-drawer" (click)="closeDrawer()">âœ•</button>
      </div>

      <div class="drawer-body">
        <div class="drawer-field">
          <label>Producto</label>
          <input type="text" [(ngModel)]="newItem.productName" placeholder="Ej. EdredÃ³n King rosa" class="drawer-input"
            (keydown.enter)="focusField('qty')">
        </div>

        <div class="drawer-row">
          <div class="drawer-field half">
            <label>Cantidad</label>
            <div class="qty-stepper">
              <button (click)="newItem.quantity = Math.max(1, newItem.quantity - 1)">âˆ’</button>
              <input type="number" [(ngModel)]="newItem.quantity" min="1" #qtyInput class="drawer-input center"
                (keydown.enter)="focusField('price')">
              <button (click)="newItem.quantity = newItem.quantity + 1">+</button>
            </div>
          </div>
          <div class="drawer-field half">
            <label>Precio unitario</label>
            <div class="price-input-wrap">
              <span class="currency">$</span>
              <input type="number" [(ngModel)]="newItem.unitPrice" min="0" #priceInput class="drawer-input with-prefix"
                (keydown.enter)="addItemToOrder()">
            </div>
          </div>
        </div>

        @if (newItem.productName && newItem.unitPrice > 0) {
        <div class="preview-line">
          <span class="preview-qty">{{ newItem.quantity }}x</span>
          <span class="preview-name">{{ newItem.productName }}</span>
          <span class="preview-total">$ {{ (newItem.quantity * newItem.unitPrice) | number:'1.2-2' }}</span>
        </div>


        }

        @if (editingItem()) {
        <button class="btn-add-item info" (click)="saveItemChanges()"
          [disabled]="!newItem.productName || newItem.unitPrice <= 0">
          ğŸ’¾ Guardar cambios
        </button>
        } @else {
        <button class="btn-add-item" (click)="addItemToOrder()"
          [disabled]="!newItem.productName || newItem.unitPrice <= 0">
          âœ¨ Agregar al pedido
        </button>
        }

        <!-- Items ya en el pedido -->
        @if (drawerOrder()?.items?.length) {
        <div class="drawer-current-items">
          <label class="section-label">En este pedido:</label>
          @for (item of drawerOrder()!.items; track item.id) {
          <div class="mini-item-chip">
            <span class="chip-qty">{{ item.quantity }}Ã—</span>
            <span class="chip-name">{{ item.productName }}</span>
            <span class="chip-price">$ {{ item.lineTotal | number:'1.2-2' }}</span>
          </div>
          }
          <div class="drawer-total-row">
            <span>Total actual</span>
            <span class="drawer-total-value">$ {{ drawerOrder()!.total | number:'1.2-2' }}</span>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
  }

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL: RESULTADO UPLOAD EXCEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (uploadResult()) {
  <div class="modal-overlay" (click)="uploadResult.set(null)">
    <div class="modal-card upload-result-modal" (click)="$event.stopPropagation()">
      <div class="modal-petals">
        <span class="petal p1">ğŸ“„</span>
        <span class="petal p2">âœ¨</span>
        <span class="petal p3">ğŸ‰</span>
      </div>
      <div class="modal-icon-circle success">ğŸ‰</div>
      <h3>Â¡Excel cargado!</h3>
      <div class="upload-stats">
        <div class="stat-bubble">
          <span class="stat-num">{{ uploadResult()!.ordersCreated }}</span>
          <span class="stat-txt">Pedidos</span>
        </div>
        <div class="stat-bubble">
          <span class="stat-num">{{ uploadResult()!.clientsCreated }}</span>
          <span class="stat-txt">Clientes nuevos</span>
        </div>
      </div>
      @if (uploadResult()!.warnings.length) {
      <div class="upload-warnings">
        <label>âš ï¸ Notas:</label>
        @for (w of uploadResult()!.warnings; track w) {
        <p>{{ w }}</p>
        }
      </div>
      }
      <div class="modal-actions">
        <button class="btn-modal-pink" (click)="uploadResult.set(null)">Â¡Perfecto! ğŸ’…</button>
      </div>
    </div>
  </div>
  }

  @if (showOptimizer()) {
  <app-route-optimizer [orders]="selectedOrdersList()" (cancel)="showOptimizer.set(false)"
    (confirmRoute)="handleRouteConfirmed($event)">
  </app-route-optimizer>
  }

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PÃGINA PRINCIPAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page-header">
    <div class="header-text">
      <h2>Pedidos ğŸ›’</h2>
      <p class="page-sub">Administra tus ventas, CEO âœ¨</p>
    </div>
    <div class="header-controls">
      <button class="btn-toggle-select" [class.active]="selectionMode()" (click)="toggleSelectionMode()">
        {{ selectionMode() ? 'âŒ Salir' : 'âœ¨ Organizar Ruta' }}
      </button>
      <button class="btn-icon-circle" (click)="loadOrders()" title="Recargar">ğŸ”„</button>

      <!-- Upload rÃ¡pido -->
      <label class="btn-upload-quick" title="Cargar Excel">
        <span>ğŸ“„</span>
        <input type="file" accept=".xlsx,.xls" (change)="onQuickUpload($event)" hidden>
      </label>

      <select [(ngModel)]="statusFilter" (change)="applyFilter()" class="filter-select">
        <option value="">Todos</option>
        <option value="Pending">â³ Pendientes</option>
        <option value="InRoute">ğŸš— En ruta</option>
        <option value="Shipped">ğŸ“¦ Enviado</option>
        <option value="Delivered">ğŸ’ Entregados</option>
        <option value="Postponed">ğŸ“… Pospuestos</option>
        <option value="PaymentPending" style="font-weight: 800; color: #db2777;">ğŸ’¸ Por Cobrar</option>
        <option value="Canceled">ğŸš« Cancelados</option>
      </select>

      <select [(ngModel)]="clientTypeFilter" (change)="applyFilter()" class="filter-select">
        <option value="">ğŸ‘¤ Tipo Clienta</option>
        <option value="Nueva">ğŸŒ± Nueva</option>
        <option value="Frecuente">ğŸ’ Frecuente</option>
      </select>

      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" [(ngModel)]="searchTerm" (input)="onSearchChange()" placeholder="Buscar cliente o #ID..."
          class="search-input">
        @if (searchTerm) {
        <button class="search-clear" (click)="searchTerm = ''; applyFilter()">âœ•</button>
        }
      </div>
    </div>
  </div>

  <!-- Quick stats -->
  <div class="quick-stats">
    <div class="qs-chip">
      <span class="qs-num">{{ orderStats().total }}</span>
      <span class="qs-label">Total</span>
    </div>
    <div class="qs-chip pending">
      <span class="qs-num">{{ orderStats().pending }}</span>
      <span class="qs-label">Pendientes</span>
    </div>
    <div class="qs-chip revenue">
      <span class="qs-num">$ {{ orderStats().pendingAmount | number:'1.0-0' }}</span>
      <span class="qs-label">Por Cobrar</span>
    </div>
    <div class="qs-chip delivered">
      <span class="qs-num">$ {{ orderStats().collectedToday | number:'1.0-0' }}</span>
      <span class="qs-label">Cobrado Hoy</span>
    </div>
  </div>

  <!-- Upload Drop Zone (drag & drop) -->
  <div class="drop-zone" [class.active]="isDragging()" (dragover)="onDragOver($event)"
    (dragleave)="isDragging.set(false)" (drop)="onDrop($event)">
    @if (uploading()) {
    <div class="upload-progress">
      <div class="spinner-cute"></div>
      <p>Procesando Excel... âœ¨</p>
    </div>
    } @else {
    <div class="drop-content">
      <span class="drop-icon">ğŸ“„</span>
      <p class="drop-text">Arrastra tu archivo Excel aquÃ­</p>
      <p class="drop-hint">o usa el botÃ³n ğŸ“„ de arriba</p>
    </div>
    }
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ROUTE BASKET (DOCK) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (selectionMode() || selectedIds().size > 0) {
  <div class="route-dock-container">
    <div class="route-dock">

      <div class="dock-left">
        <div class="dock-icon-wrapper">
          <span class="dock-icon">ğŸ›µ</span>
          <span class="badge-count">{{ selectedIds().size }}</span>
        </div>
        <div class="dock-info">
          <h4>Ruta en proceso</h4>
          <p>Total: <strong>$ {{ selectedOrdersTotal() | number:'1.0-0' }}</strong></p>
        </div>
      </div>

      <div class="dock-avatars">
        @for (order of selectedOrdersList(); track order.id) {
        <div class="mini-avatar" [title]="order.clientName">
          {{ order.clientName.charAt(0) }}
          <span class="check-mini">âœ“</span>
        </div>
        }
        @if (selectedIds().size === 0) {
        <span class="empty-hint">Toca las tarjetas para agregar...</span>
        }
      </div>

      <button class="btn-create-route-dock" (click)="createRoute()" [disabled]="selectedIds().size === 0 || loading()">
        <span>Crear Ruta</span>
        <span class="arrow">â†’</span>
      </button>
    </div>
  </div>
  }

  <!-- Orders grid -->
  <div class="orders-grid">
    @for (order of filteredOrders(); track order.id) {
    <div class="order-card" [class.selection-mode]="selectionMode()" [class.selected]="selectedIds().has(order.id)"
      [attr.data-status]="order.status" (click)="selectionMode() ? toggleOrder(order) : goToOrder(order.id)">

      @if (selectionMode() && selectedIds().has(order.id)) {
      <div class="selection-stamp">
        <span>ğŸ€</span>
      </div>
      }

      <div class="card-header">
        <div class="client-meta">
          <span class="order-id">#{{ order.id }}</span>
          <span class="order-type-tag" [class.pickup]="order.orderType === 'PickUp'">
            {{ order.orderType === 'PickUp' ? 'ğŸ›ï¸ LOCAL' : 'ğŸ›µ ENVÃO' }}
          </span>
          @for (tag of order.tags; track tag) {
          <span class="tag-pill">{{ tag }}</span>
          }
        </div>
        <span class="status-pill" [attr.data-status]="order.status">
          {{ statusLabel(order.status) }}
        </span>
      </div>

      <div class="card-body">
        <div class="client-info">
          <div class="name-check">
            @if ((order.status === 'Pending' || order.status === 'Confirmed' || order.status === 'Shipped') &&
            order.orderType === 'Delivery') {
            <label class="custom-checkbox" (click)="$event.stopPropagation()">
              <input type="checkbox" [checked]="selectedIds().has(order.id)" (change)="toggleOrder(order)">
              <span class="checkmark"></span>
            </label>
            }
            <h3 class="client-name">{{ order.clientName }}</h3>
          </div>

          <!-- CLIENT TYPE BADGE -->
          <div class="client-badges">
            @if (order.clientType === 'Frecuente') {
            <span class="badge-vip">ğŸ’ FRECUENTE</span>
            } @else {
            <span class="badge-new">ğŸŒ± NUEVA</span>
            }
          </div>
        </div>

        @if (order.status === 'Postponed' && order.postponedAt) {
        <div class="postponed-alert">
          <span class="alert-icon">ğŸ“…</span>
          <div>
            <p class="date">{{ order.postponedAt | date:'fullDate' }}</p>
            @if (order.postponedNote) { <p class="note">"{{ order.postponedNote }}"</p> }
          </div>
        </div>
        }

        <div class="items-scroll-row">
          <div class="items-track">
            @for (item of order.items; track item.id) {
            <div class="item-chip">
              <span class="qty">{{ item.quantity }}Ã—</span>
              <span class="name">{{ item.productName }}</span>
              <span class="price">$ {{ item.lineTotal | number:'1.0-0' }}</span>
              @if (order.status === 'Pending') {
              <button class="btn-icon-mini edit" (click)="$event.stopPropagation(); openEditItem(order, item)"
                title="Editar">âœï¸</button>
              <button class="btn-icon-mini delete" (click)="$event.stopPropagation(); askDeleteItem(order, item)"
                title="Eliminar">âœ•</button>
              }
            </div>
            }
            @if (order.status === 'Pending') {
            <button class="item-chip add-chip" (click)="openDrawer(order)">
              <span class="plus">ï¼‹</span>
            </button>
            }
          </div>
        </div>
        @if (order.items.length > 0) {
        <div class="items-summary">
          <span>{{ order.items.length }} artÃ­culo{{ order.items.length > 1 ? 's' : '' }}</span>
          <span class="swipe-hint">desliza â†’</span>
        </div>
        }
      </div>

      <div class="card-footer">
        <div class="total-section">
          <span class="total-label">Total</span>
          <span class="total-amount">$ {{ order.total | number:'1.2-2' }}</span>
        </div>
        <div class="card-buttons">
          @if (order.status === 'Pending' || order.status === 'InRoute') {
          <button class="action-btn pay" (click)="$event.stopPropagation(); openConfirmPayment(order)"
            title="Confirmar Cobro">ğŸ’°</button>
          }
          <button class="action-btn link" (click)="$event.stopPropagation(); copyLink(order.link)"
            title="Copiar Link">ğŸ“‹</button>
          <button class="action-btn edit" (click)="$event.stopPropagation(); openEditModal(order)"
            title="Editar">âœï¸</button>
          <button class="action-btn delete" (click)="$event.stopPropagation(); askDeleteOrder(order)"
            title="Eliminar">ğŸ—‘ï¸</button>
          <span class="action-arrow" title="Ver detalle">â†’</span>
        </div>
      </div>
    </div>
    } @empty {
    @if (!loading()) {
    <div class="empty-state">
      <div class="empty-icon">ğŸ›ï¸</div>
      <h3>No hay pedidos</h3>
      <p>Carga un Excel, crea uno manual o ajusta tus filtros.</p>
    </div>
    } @else {
    <div class="empty-state">
      <div class="empty-icon spinner-cute"></div>
      <h3>Cargando pedidos...</h3>
    </div>
    }
    }
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGINATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (totalPages() > 1 && !loading()) {
  <div class="pagination-controls">
    <button class="btn-page" (click)="changePage(-1)" [disabled]="currentPage() === 1">â† Anterior</button>
    <div class="page-info">
      PÃ¡gina <strong>{{ currentPage() }}</strong> de {{ totalPages() }}
      <span class="total-hint">({{ totalOrdersCount() }} pedidos)</span>
    </div>
    <button class="btn-page" (click)="changePage(1)" [disabled]="currentPage() >= totalPages()">Siguiente â†’</button>
  </div>
  }

  <!-- Route success -->
  @if (routeCreated()) {
  <div class="route-success-card">
    <div class="icon">ğŸš—ğŸ’¨</div>
    <div class="info">
      <h4>Â¡Ruta creada con Ã©xito!</h4>
      <p>EnvÃ­a este link al repartidor:</p>
      <div class="copy-box">
        <input type="text" [value]="routeCreated()!.driverLink" readonly>
        <button (click)="copyDriverLink()">Copiar</button>
      </div>
    </div>
    <button class="close-btn" (click)="routeCreated.set(null)">âœ•</button>
  </div>
  }
</div>